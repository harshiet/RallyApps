<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 <!-- Copyright (c) 2011 Rally Software Development Corp. All rights reserved -->
 <html>
 <head>
     <title>Object Dropdown Example</title>
     <meta name="Name" content="Component Example: Object Drop-down" />
     <meta name="Version" content="1.26" />
     <meta name="Vendor" content="Rally Software" />
 
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/1.32/sdk.js"></script>
     <script type="text/javascript">
		var rallyDataSource;
		function projectChanged(dropdown, eventArgs) {
           clearDiv('bDiv');
		   var selectedProject = eventArgs.value;
		   rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              rally.sdk.util.Ref.getOidFromRef(selectedProject),
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
		   rallyDataSource.getRallyObject(selectedProject, onGetComplete);
		}
		function onGetComplete(obj) {
          var type = rally.sdk.util.Ref.getTypeFromRef(obj); 
		  if(type=="project"){
			var releases = obj.Releases;
			for(var i=0;i<releases.length;i++){
				rallyDataSource.getRallyObject(releases[i],onGetComplete);
			}
		  }else{
			if(type=="release"){
				updateDiv('bDiv',obj.Name);
				findAcceptedUserStoriesForRelease(obj);
			}
		  }
         }

		 function findAcceptedUserStoriesForRelease(release){
			var queryConfig = {
				type : 'hierarchicalrequirement',
				key : 'stories',
				query : '((ScheduleState = Accepted) AND (Release.ObjectID = "' + release.ObjectID + '"))',
				fetch : 'Name,AcceptedDate,TaskActualTotal,TaskEstimateTotal,Iteration,Name,ObjectID',
				pagesize:'2000'
			};
			rallyDataSource.findAll(queryConfig, showUserStories);
		 }
		 function showUserStories(results){
			for (i = 0; i < results.stories.length; i++) {
				var story = results.stories[i];
				updateDiv('bDiv',i+story.Iteration.Name + "," + story.TaskActualTotal);
			}
 		 }
       function onLoad() {
           rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              '__PROJECT_OID__',
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
           var config = {
                 type : "Project",
                 attribute: "Name"
              };
           var projectDropdown = new rally.sdk.ui.ObjectDropdown(config, rallyDataSource);
              projectDropdown.display("aDiv", projectChanged);
        }
 
		rally.addOnLoad(onLoad);
 		function clearDiv(divId){
			var oDiv = document.getElementById(divId);
			 oDiv.innerHTML = '';
    	}

		function updateDiv(divId,text){
			var oDiv = document.getElementById(divId);
			 oDiv.innerHTML += text+ "<br>";
    	}
    
    </script>
 </head>
   <body>
     <div id="aDiv"></div>
	 <div id="bDiv"></div>
 </body>
 </html>