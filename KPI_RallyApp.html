<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 <!-- Copyright (c) 2011 Rally Software Development Corp. All rights reserved -->
 <html>
 <head>
     <title>Object Dropdown Example</title>
     <meta name="Name" content="Component Example: Object Drop-down" />
     <meta name="Version" content="1.26" />
     <meta name="Vendor" content="Rally Software" />
 
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/1.32/sdk.js"></script>
     <script type="text/javascript">
		var rallyDataSource;
		var table = null;
		
		function projectChanged(dropdown, eventArgs) {
           clearDiv('bDiv');
		   var selectedProject = eventArgs.value;
		   rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              rally.sdk.util.Ref.getOidFromRef(selectedProject),
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
			if(table){
				table.destroy();
			}
			findAcceptedUserStories();
         }
		 function findAcceptedUserStories(){
			var queryConfig = {
				type : 'hierarchicalrequirement',
				key : 'stories',
				query : '((ScheduleState = Accepted) OR (ScheduleState = Closed))',
				fetch : 'Name,AcceptedDate,TaskActualTotal,TaskEstimateTotal,Iteration,Name,ObjectID,Release,Name,ObjectID',
				pagesize:'20000',
				order: 'AcceptedDate desc'

			};
			rallyDataSource.findAll(queryConfig, processStories);
		 }
	     function processStories(results){
			var ds = {};
			for (i = 0; i < results.stories.length; i++) {
				var story = results.stories[i];
				var releaseName="No Release Assigned";
				if(story.Release){
					releaseName = story.Release.Name;
				}
				var iterationName = "No Iteration Assigned";
				if(story.Iteration){
					iterationName = story.Iteration.Name;
				}
				if (!ds[releaseName]) {
					ds[releaseName]={};
				}
				if (!ds[releaseName][iterationName]) {
					ds[releaseName][iterationName] = {};
					dsIter=ds[releaseName][iterationName];
					dsIter['taskEstimate'] = 0;
					dsIter['taskActual'] = 0;
				}
				dsIter=ds[releaseName][iterationName];
				dsIter['taskEstimate'] +=  story.TaskEstimateTotal;	
				dsIter['taskActual'] += story.TaskActualTotal;	
			}
			display(ds);
		  }

		function display(ds){
			 var tableDiv = document.getElementById("tableDiv");
			 var tableConfig = { columns: 
             [{key: 'Release', header: 'Release'},
			 {key: 'Iteration', header: 'Iteration'}, 
             {key: 'TaskEstimateTotal', header: 'Estimated Effort',width:100},
             {key: 'TaskActualTotal', header: 'ActualEffort',width:100},
			 ],
			 width:700};
			table = new rally.sdk.ui.Table(tableConfig );
			for(rel in ds){
				var dsRel = ds[rel];
				for(iter in dsRel){
					var dsIter = dsRel[iter];
					table.addRow({'Release' : rel, 'Iteration' : iter, 'TaskEstimateTotal' : dsIter['taskEstimate'], 'TaskActualTotal' : dsIter['taskActual']});
				}
			}
			
			table.display(tableDiv);
		}
       function onLoad() {
           rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              '__PROJECT_OID__',
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
           var config = {
                 type : "Project",
                 attribute: "Name"
              };
           var projectDropdown = new rally.sdk.ui.ObjectDropdown(config, rallyDataSource);
              projectDropdown.display("aDiv", projectChanged);
        }
 
		rally.addOnLoad(onLoad);

 		function clearDiv(divId){
			var oDiv = document.getElementById(divId);
			 oDiv.innerHTML = '';
    	}

		function updateDiv(divId,text){
			var oDiv = document.getElementById(divId);
			 oDiv.innerHTML += text+ "<br>";
    	}

    </script>
 </head>
   <body>
     <div id="aDiv"></div>
	 <div id="bDiv"></div>
	 <div id="tableDiv"></div>
 </body>
 </html>