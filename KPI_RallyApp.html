<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 <!-- Copyright (c) 2011 Rally Software Development Corp. All rights reserved -->
 <html>
 <head>
     <title>Object Dropdown Example</title>
     <meta name="Name" content="KPIs" />
     <meta name="Version" content="1.32" />
     <meta name="Vendor" content="CEB" />
 
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/1.32/sdk.js"></script>
     <script type="text/javascript">
		var rallyDataSource;
		var table = null;
		var releaseDropdown=null;
		var objRelease = null;
		function LineItem(name){
			this.name = name;
			this.estimatedEffort = 0;
			this.actualEffort = 0;
			this.startDate='';
			this.endDate='';
			this.capacity=0;
			this.iterations = {};
			this.getEstimatedEffort = function(){
				return formatNumber(this.estimatedEffort);
			}
			this.getActualEffort = function(){
				return formatNumber(this.actualEffort);
			}
		}
		function projectChanged(dropdown, eventArgs) {
		   cleanUpAll();
		   var selectedProject = eventArgs.value;
		   rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              rally.sdk.util.Ref.getOidFromRef(selectedProject),
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
			releaseDropdown = new rally.sdk.ui.ObjectDropdown( { type:"Release", label : "Select a release ", width:"300",order:"StartDate desc", attribute:"Name"}, rallyDataSource); 
			releaseDropdown.display("releaseDiv", releaseChanged);
         }
		 function releaseChanged(dropdown, eventArgs) {
			cleanUp(table);
			var selectedRelease = eventArgs.value;
			rallyDataSource.getRallyObject(selectedRelease,function(obj){
				objRelease = new LineItem(obj.Name);
				objRelease.startDate = formatDate(obj.ReleaseStartDate);
				objRelease.endDate = formatDate(obj.ReleaseDate);
				findUserStoriesForRelease(objRelease);
			}); 
        }

		 function findUserStoriesForRelease(objRelease){
			var queryConfig = {
				type : 'hierarchicalrequirement',
				key : 'stories',
				query : '(((ScheduleState = Accepted) OR (ScheduleState = Closed)) AND (Release.Name = "' + objRelease.name +'"))',
				fetch : 'Name,AcceptedDate,TaskActualTotal,TaskEstimateTotal,Iteration,Name,ObjectID,StartDate,EndDate,UserIterationCapacities,Capacity,Release,Name,ObjectID,StartDate,ReleaseDate',
				pagesize:'20000',
				order: 'AcceptedDate desc'

			};
			rallyDataSource.findAll(queryConfig, processStories);
		 }
	     function processStories(results){
			
			for (i = 0; i < results.stories.length; i++) {
				var story = results.stories[i];
				var iterationName = "No Iteration Assigned";
				var iterationObjectID = "xxxxxxxxxxxxxxxxxxx";
				var iterationStartDate = "";
				var iterationEndDate = "";
				var iterationCapacity=0;
				if(story.Iteration){
					iterationName = story.Iteration.Name;
					iterationObjectID = story.Iteration.ObjectID;
					iterationStartDate = story.Iteration.StartDate;
					iterationEndDate = story.Iteration.EndDate;
					for(x in story.Iteration.UserIterationCapacities){
						var uCap = story.Iteration.UserIterationCapacities[x];
						iterationCapacity += uCap.Capacity;
					}
				}
				var iteration = objRelease.iterations[iterationObjectID];

				if (!iteration) {
					iteration = new LineItem(iterationName);
					iteration.startDate = formatDate(iterationStartDate);
					iteration.endDate = formatDate(iterationEndDate);
					objRelease.iterations[iterationObjectID] = iteration;
				}
				iteration.estimatedEffort +=  story.TaskEstimateTotal;	
				iteration.actualEffort += story.TaskActualTotal;
				iteration.capacity = iterationCapacity;
				objRelease.estimatedEffort += story.TaskEstimateTotal;
				objRelease.actualEffort += story.TaskActualTotal;
				objRelease.capacity += iterationCapacity;
				
			}
			display(objRelease);
		  }

		function display(release){
			 var tableDiv = document.getElementById("tableDiv");
			 var tableConfig = { columns: 
             [{key: 'Release', header: 'Release', width:500},
			 {key: 'StartDate', header: 'Start Date'},
			 {key: 'EndDate', header: 'End Date'},
			 {key: 'TaskEstimateTotal', header: 'Estimated Effort'},
             {key: 'TaskActualTotal', header: 'Actual Effort'},
             {key: 'TeamCapacity', header: 'Team Capacity'},
			 ],
			 width:1000};
			table = new rally.sdk.ui.Table(tableConfig );
			table.addRow({'Release' : bold(release.name),  'StartDate':bold(release.startDate), 'EndDate':bold(release.endDate), 'TaskEstimateTotal' : bold(release.getEstimatedEffort()), 'TaskActualTotal' : bold(release.getActualEffort()), 'TeamCapacity':release.capacity});
			for(key in release.iterations){
				var iteration = release.iterations[key];
				table.addRow({'Release' : padspaces(iteration.name,20), 'StartDate':iteration.startDate, 'EndDate':iteration.endDate, 'TaskEstimateTotal' : iteration.getEstimatedEffort(), 'TaskActualTotal' : iteration.getActualEffort(), 'TeamCapacity':iteration.capacity});
			}
			table.display(tableDiv);
			
		}
       function onLoad() {
           rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              '__PROJECT_OID__',
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
			var projectDropdown = new rally.sdk.ui.ObjectDropdown({
                 type : "Project",
                 attribute: "Name",
				 order:"Name",
				 label:"Select a project"}, rallyDataSource);
			projectDropdown.display("projectDiv", projectChanged);
		}

		function cleanUpAll(){
			cleanUp(table);
			cleanUp(releaseDropdown);
		}
		function cleanUp(obj){
			try{
				if(obj){
					obj.destroy();
				}
			}catch(err){}
		}
		function bold(text){
			return '<b>' + text + '</b>';
		}
		function formatNumber(num){
			return num.toFixed(0);
		}
		function formatDate(date){
			if(date == ""){
				return date;
			}
			return rally.sdk.util.DateTime.format(date, "dd-MMM-yyyy");
		}
		function padspaces(text, numspaces){
			for(var i=0;i<numspaces;i++){
				text='&nbsp;'+text;
			}
			return text;
		}
		rally.addOnLoad(onLoad);
    </script>
 </head>
   <body>
     <div id="projectDiv"></div>
	 <div id="releaseDiv"></div>
	 
	 <div id="tableDiv"></div>
 </body>
 </html>