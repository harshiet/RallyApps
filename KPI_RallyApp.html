<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Copyright (c) 2011 Rally Software Development Corp. All rights reserved -->
<html>
<head>
<title>Object Dropdown Example</title>
<meta name="Name" content="KPIs" />
<meta name="Version" content="1.32" />
<meta name="Vendor" content="CEB" />

<script type="text/javascript"
	src="https://rally1.rallydev.com/apps/1.32/sdk.js"></script>
<script type="text/javascript">
		var rallyDataSource;
		var table = null;
		var tableKPI = null;
		var releaseDropdown=null;
		var objRelease = null;
		var productiveHrsPerDay = 6;
		var kpiMap = {};
		kpiMap['tu'] = ['Team Utilization', 'Actual Hours Spent / Total Team Capacity in Hours'];
		kpiMap['tp'] = ['Team Productivity','Number of Story Points Delivered / Total Team Capacity in Story Points'];
		kpiMap['sv'] = ['Schedule Variance','(Actual Completion Date – Planned Completion Date) / Total Release Duration'];
		kpiMap['ev'] = ['Estimate Variance','1 – (Actual Effort / Estimated Effort )'];
		kpiMap['qu'] = ['Quality','1- (Actual effort spent on Post-Production defects/Total Actual Release Effort)'];
		kpiMap['wdd'] = ['Weighted Defect Density','(Critical Defects Effort * 5 + High Defects * 3 + Medium Defects * 2 + Low Defects * 1) / Total Actual Release Effort'];
		kpiMap['otdi'] = ['On Time Delivery Index','Total milestones delivered on time / Total milestones delivered'];
		kpiMap['da'] = ['Defect Aging','Number of defects open for <1 week, 1-2 weeks, 2-4 weeks, >4 weeks'];
		kpiMap['mtr'] = ['Mean Time to Resolve','Average of the effort spent in hours to fix bugs reported by partners in each of the following applicable categories - P1, P2, P3 and P4'];

		function LineItem(name){
			this.name = name;
			this.estimatedEffort = 0;
			this.actualEffort = 0;
			this.startDate='';
			this.plannedEndDate='';
			this.actualEndDate='';
			this.capacity=0;
			this.estimatedStoryPoints = 0;
			this.iterations = {};
			this.postProductionDefectsEffortActual = 0;
			this.getEstimatedEffort = function(){
				return formatNumber(this.estimatedEffort);
			}
			this.getActualEffort = function(){
				return formatNumber(this.actualEffort);
			}
			this.getUtilization = function(){
				return formatNumber((this.actualEffort/this.capacity)*100) + '%';
			}
			this.getProductivity = function(){
				return formatNumber((this.estimatedStoryPoints/this.capacityInStoryPoints())*100) + '%';
			}
			this.capacityInStoryPoints = function(){
				return this.capacity/productiveHrsPerDay;
			}
			this.getScheduleVariance = function(){
				return formatNumber((rally.sdk.util.DateTime.getDifference(new Date(this.actualEndDate), new Date(this.plannedEndDate), "day")
				/rally.sdk.util.DateTime.getDifference(new Date(this.actualEndDate), new Date(this.startDate), "day"))*100) + '%';		
			}
			this.getEstimateVariance = function(){
				return formatNumber((1-(this.actualEffort/this.estimatedEffort))*100) + '%';	
			}
			this.getQuality = function(){
				return "TBD";	
			}
			this.getWeightedDefectDensity = function(){
				return "TBD";	
			}

		}
		function projectChanged(dropdown, eventArgs) {
			showSpinner();
			cleanUpAll();
		   	var selectedProject = eventArgs.value;
		   	rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              rally.sdk.util.Ref.getOidFromRef(selectedProject),
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
			releaseDropdown = new rally.sdk.ui.ObjectDropdown( { type:"Release", label : "Select a release ", width:"300",order:"StartDate desc", attribute:"Name"}, rallyDataSource); 
			releaseDropdown.display("releaseDiv", releaseChanged);
         }
		 function releaseChanged(dropdown, eventArgs) {
			showSpinner();
			cleanUp(table);
			cleanUp(tableKPI);
			var selectedRelease = eventArgs.value;
			rallyDataSource.getRallyObject(selectedRelease,function(obj){
				objRelease = new LineItem(obj.Name);
				objRelease.startDate = obj.ReleaseStartDate;
				objRelease.actualEndDate = obj.ReleaseDate;
				findPlannedReleaseDateForRelease(obj);
				calculateKPIsForRelease(objRelease);
			}); 
        }

		function findPlannedReleaseDateForRelease(obj){
			var queryConfig = {
				type : 'Release.RevisionHistory.Revisions',
				key : 'revisions',
				query : '(ObjectID = "' + obj.ObjectID +'")',
				fetch : 'Revision,Description,RevisionNumber',
				pagesize:20000,
				order: 'RevisionNumber desc'
			};
			rallyDataSource.findAll(queryConfig,function(results){
				var minRevNum = 1000000;
				var date = "";
				for(x in results.revisions){
					var desc = results.revisions[x].Description;
					var revNum = results.revisions[x].RevisionNumber;
					var index = desc.indexOf('RELEASE DATE changed from ');
					if( index >= 0){
						if(revNum < minRevNum){
							minRevNum = revNum;
							date = desc.substring(desc.indexOf('[', index)+1,desc.indexOf(']', index));
						}
					}
				}
				if(date == ""){
					date = obj.ReleaseDate;
				}
				objRelease.plannedEndDate = date;
			});
					
		}

		function calculateKPIsForRelease(objRelease){
			var queryConfig = [];
			queryConfig[0] = {
				type : 'hierarchicalrequirement',
				key : 'stories',
				query : '((((ScheduleState = Completed) OR(ScheduleState = Accepted)) OR (ScheduleState = Closed)) AND (Release.Name = "' + objRelease.name +'"))',
				fetch : 'Name,TaskActualTotal,TaskEstimateTotal,PlanEstimate,Iteration,Name,ObjectID,StartDate,EndDate,UserIterationCapacities,Capacity',
				pagesize:20000,
				order:"AcceptedDate desc"
			};
			queryConfig[1] = {
				type : 'defect',
				key : 'defects',
				query : '((State = Closed) AND (Release.Name = "' + objRelease.name +'"))',
				fetch : 'Name,TaskActualTotal,TaskEstimateTotal,PlanEstimate,Iteration,Name,ObjectID,StartDate,EndDate,UserIterationCapacities,Capacity',
				pagesize:20000,
				order:"AcceptedDate desc"
			};
			queryConfig[2] = {
				type : 'defect',
				key : 'post_production_defects',
				query : '((Environment = "Post-Production") AND (Release.Name = "' + objRelease.name +'"))',
				fetch : 'Name,TaskActualTotal',
				pagesize:20000,
				order:"AcceptedDate desc"
			};

			rallyDataSource.findAll(queryConfig, processResults);
		 }
	     function processResults(results){
			for(property in results){
				if(property == 'post_production_defects'){
					for (var i=0 ; i < results[property].length ; i++) {
						objRelease.postProductionDefectsEffortActual+=results[property][i].TaskActualTotal;	
					}
				}else{
					var artifact;
					for (var i=0 ; i < results[property].length ; i++) {
						artifact = results[property][i];
						var iterationName = "No Iteration Assigned";
						var iterationObjectID = "xxxxxxxxxxxxxxxxxxx";
						var iterationStartDate = "";
						var iterationEndDate = "";
						var iterationCapacity=0;
						if(artifact.Iteration){
							var aIteration = artifact.Iteration;
							iterationName = aIteration.Name;
							iterationObjectID = aIteration.ObjectID;
							iterationStartDate = aIteration.StartDate;
							iterationEndDate = aIteration.EndDate;
							if(!objRelease.iterations[iterationObjectID]){
								for(x in aIteration.UserIterationCapacities){
									var uCap = aIteration.UserIterationCapacities[x];
									iterationCapacity += uCap.Capacity;
								}
							}
						}
						var iteration = objRelease.iterations[iterationObjectID];
						if (!iteration) {
							iteration = new LineItem(iterationName);
							iteration.startDate = iterationStartDate;
							iteration.actualEndDate = iterationEndDate;
							iteration.capacity = iterationCapacity;
							objRelease.iterations[iterationObjectID] = iteration;
							objRelease.capacity += iterationCapacity;
						}
						iteration.estimatedEffort +=  artifact.TaskEstimateTotal;	
						iteration.actualEffort += artifact.TaskActualTotal;
						iteration.estimatedStoryPoints+=artifact.PlanEstimate;
						objRelease.estimatedEffort += artifact.TaskEstimateTotal;
						objRelease.actualEffort += artifact.TaskActualTotal;
						objRelease.estimatedStoryPoints += artifact.PlanEstimate;
					}
				}
			}
			display(objRelease);
		}
		function display(release){
			var tableDiv = document.getElementById("tableDiv");
			tableDiv.innerHTML = '<br/><b><span style="font-size:1.2em;padding:2px;">Data used to determine KPIs</span></b> <br/><br/>';
			var tableConfig = { columns: 
             [{key: 'Release', header: 'Release', width:'300'},
			 {key: 'StartDate', header: 'Start date'},
			 {key: 'PlannedEndDate', header: 'Planned end date'},
			 {key: 'ActualEndDate', header: 'Actual end date'},
			{key: 'TaskEstimateTotal', header: 'Estimated effort (Hr)'},
             {key: 'TaskActualTotal', header: 'Actual effort (Hr)'},
             {key: 'TeamCapacityH', header: 'Team capacity (Hr)'},
             {key: 'TeamCapacitySP', header: 'Team capacity (SP)'},
 			 {key: 'EstimatedStoryPoints', header: 'Est. Story Points'}
			 ]};
			table = new rally.sdk.ui.Table(tableConfig );
			table.addRow({'Release' : bold(release.name),'StartDate':bold(formatDate(release.startDate)),'PlannedEndDate':bold(formatDate(release.plannedEndDate)),'ActualEndDate':bold(formatDate(release.actualEndDate)), 'TaskEstimateTotal' : bold(release.getEstimatedEffort()), 'TaskActualTotal' : bold(release.getActualEffort()),'TeamCapacityH':bold(release.capacity),'TeamCapacitySP':bold(formatNumber(release.capacityInStoryPoints())),'EstimatedStoryPoints':bold(release.estimatedStoryPoints)});
			for(key in release.iterations){
				var iteration = release.iterations[key];
				table.addRow({'Release' : padspaces(iteration.name,10),'StartDate':formatDate(iteration.startDate),'ActualEndDate':formatDate(iteration.actualEndDate), 'TaskEstimateTotal' : iteration.getEstimatedEffort(), 'TaskActualTotal' : iteration.getActualEffort(),'TeamCapacityH':iteration.capacity,'TeamCapacitySP':formatNumber(iteration.capacityInStoryPoints()),'EstimatedStoryPoints':iteration.estimatedStoryPoints});
			}
			table.display(tableDiv);
			
			displayKPI(release);
		}
		function displayKPI(release){
		 	var tableDiv = document.getElementById("tableKPIDiv");
			tableDiv.innerHTML = '<br/><b><span style="font-size:1.2em;padding:2px;">KPIs for Release: ' + release.name + '</span></b> <br/><br/>';
	 		var tableConfig = { columns: 
     		[{key: 'KPI1', header: 'KPI'},
	 		 {key: 'Value1', header: 'Value'},
	 		 {key: 'KPI2', header: 'KPI'},
	 		 {key: 'Value2', header: 'Value'}],
				width:800};
			tableKPI = new rally.sdk.ui.Table(tableConfig );
			tableKPI.addRow({'KPI1':kpiLabel("tu"), 'Value1':bold(release.getUtilization()),'KPI2':kpiLabel("wdd"), 'Value2':bold(release.getWeightedDefectDensity())});
			tableKPI.addRow({'KPI1':kpiLabel("tp"), 'Value1':bold(release.getProductivity()),'KPI2':kpiLabel("otdi"), 'Value2':bold('TBD')});
			tableKPI.addRow({'KPI1':kpiLabel("sv"), 'Value1': bold(release.getScheduleVariance()),'KPI2':kpiLabel("da"), 'Value2':bold('TBD')});
			tableKPI.addRow({'KPI1':kpiLabel("ev"), 'Value1':bold(release.getEstimateVariance()),'KPI2':kpiLabel("mtr"), 'Value2':bold('TBD')});
			tableKPI.addRow({'KPI1':kpiLabel("qu"), 'Value1':bold(release.getQuality())});
			tableKPI.display(tableDiv);
			createToolTips();
			hideSpinner();
		}

		function kpiLabel(kpi){
			var tip = '<span id="'+kpi+'" style="background-color:#026cfd;display: inline-block; width:15px;height:15px;margin-left:10px;color:white;text-align:center;">?</span>'
			return bold(kpiMap[kpi][0])+tip;
		}
 		function createToolTips(){
			for(kpi in kpiMap){
				var tooltip = new rally.sdk.ui.basic.Tooltip({
					message: kpiMap[kpi][1],
					position: "after"
				});
				tooltip.display(kpi);
			}
		}
		function onLoad() {
    		showSpinner();
			rally.sdk.ui.AppHeader.setHelpUrl("http://www.google.com");
			rally.sdk.ui.AppHeader.showMessage("info", "This app works best in Firefox browser");


			rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              '__PROJECT_OID__',
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
			var projectDropdown = new rally.sdk.ui.ObjectDropdown({
                 type : "Project",
                 attribute: "Name",
				 order:"Name",
				 label:"Select a project"}, rallyDataSource);
			projectDropdown.display("projectDiv", projectChanged);
		}

		function cleanUpAll(){
			cleanUp(table);
			cleanUp(releaseDropdown);
		}
		function cleanUp(obj){
			document.getElementById("tableKPIDiv").innerHTML = "";
			document.getElementById("tableDiv").innerHTML = "";
			try{
				if(obj){
					obj.destroy();
				}
			}catch(err){}
		}
		function bold(text){
			return '<b>' + text + '</b>';
		}
		function formatNumber(num){
			return num.toFixed(1);
		}
		function formatDate(date){
			if(date == ""){
				return date;
			}
			return rally.sdk.util.DateTime.format(date, "dd-MMM-yyyy");
		}
		function padspaces(text, numspaces){
			for(var i=0;i<numspaces;i++){
				text='&nbsp;'+text;
			}
			return text;
		}
		function log(text){
			document.getElementById('log').innerHTML+=text + '<br>';
		}
	    var waiter;
		var spinneron = false;
	    function hideSpinner() {
	    	waiter.hide();
	    	spinneron = false;
	    }
		function showSpinner() {
			if(!spinneron){
	        	waiter = new rally.sdk.ui.basic.Wait({hideTarget: false});
	         	waiter.display("div1");
	         	spinneron = true;
			}
	       }
		rally.addOnLoad(onLoad);
		 
    </script>
</head>
<body>
	<div style="min-height:500px;border: #000 1px dashed;padding:10px;" id="div1">
	<div id="projectDiv"></div>
	<div id="releaseDiv"></div>
	<br/>
	<div id="KPIHeader"></div>
	<div id="tableKPIDiv"></div>
	<br/>
	<div id="tableDiv"></div>
	<div id="log"></div>

	</div>
</body>
</html>