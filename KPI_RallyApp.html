<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
 <!-- Copyright (c) 2011 Rally Software Development Corp. All rights reserved -->
 <html>
 <head>
     <title>Object Dropdown Example</title>
     <meta name="Name" content="Component Example: Object Drop-down" />
     <meta name="Version" content="1.26" />
     <meta name="Vendor" content="Rally Software" />
 
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/1.32/sdk.js"></script>
     <script type="text/javascript">
		var rallyDataSource;
		var ds = {};
		function projectChanged(dropdown, eventArgs) {
           clearDiv('bDiv');
		   var selectedProject = eventArgs.value;
		   rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              rally.sdk.util.Ref.getOidFromRef(selectedProject),
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
			ds = {};															 
		   rallyDataSource.getRallyObject(selectedProject, onGetComplete);
		}
		function onGetComplete(obj) {
          var type = rally.sdk.util.Ref.getTypeFromRef(obj); 
		  if(type=="project"){
			var iterations = obj.Iterations;
			for(var i=0;i<iterations.length;i++){
				rallyDataSource.getRallyObject(iterations[i],onGetComplete);
			}
		  }else{
			if(type=="iteration"){
				//updateDiv('bDiv',obj.Name);
				findAcceptedUserStoriesForIteration(obj);
			}
		  }
         }
		 function findAcceptedUserStoriesForIteration(iteration){
			var queryConfig = {
				type : 'hierarchicalrequirement',
				key : 'stories',
				query : '((ScheduleState = Accepted) AND (Iteration.ObjectID = "' + iteration.ObjectID + '"))',
				fetch : 'Name,AcceptedDate,TaskActualTotal,TaskEstimateTotal,Iteration,Name,ObjectID,Release,Name',
				pagesize:'2000'
			};
			rallyDataSource.findAll(queryConfig, processUserStoriesForIteration);
		 }
		 function processUserStoriesForIteration(results){
			
			for (i = 0; i < results.stories.length; i++) {
				var story = results.stories[i];
				var release=story.Release;
				var iteration = story.Iteration;
				if (!ds[release.ObjectID]) {
					ds[release.ObjectID]={};
					ds[release.ObjectID]['releaseName'] = release.Name;
				}
				if (!ds[release.ObjectID][iteration.ObjectID]) {
					ds[release.ObjectID][iteration.ObjectID] = {};
					ds[release.ObjectID][iteration.ObjectID]['iterationName'] = iteration.Name;	
//					dsIter=dsRel[iteration.ObjectID];
				}
//				dsIter['taskEstimate'] = parseFloat(dsIter['taskEstimate']) + story.TaskEstimateTotal;	
//				dsIter['taskActual'] = parseFloat(dsIter['taskActual']) + story.TaskActualTotal;	
			}

			for(rel in ds){
				var dsRel = ds[rel];
				updateDiv('bDiv',dsRel['releaseName']);	
				for(iter in dsRel){
					var dsIter = dsRel[iter];
					updateDiv('bDiv',dsIter['iterationName']);	
//					updateDiv('bDiv',dsIter['iterationName'] + ',' + dsIter['taskEstimate'] + ',' + dsIter['taskActual']);	
				}
				updateDiv('bDiv','______________________________________________________________________');	
			}
 		 }
       function onLoad() {
           rallyDataSource = new rally.sdk.data.RallyDataSource('__WORKSPACE_OID__',
                                                              '__PROJECT_OID__',
                                                              '__PROJECT_SCOPING_UP__',
                                                             '__PROJECT_SCOPING_DOWN__');
           var config = {
                 type : "Project",
                 attribute: "Name"
              };
           var projectDropdown = new rally.sdk.ui.ObjectDropdown(config, rallyDataSource);
              projectDropdown.display("aDiv", projectChanged);
        }
 
		rally.addOnLoad(onLoad);
 		function clearDiv(divId){
			var oDiv = document.getElementById(divId);
			 oDiv.innerHTML = '';
    	}

		function updateDiv(divId,text){
			var oDiv = document.getElementById(divId);
			 oDiv.innerHTML += text+ "<br>";
    	}

    </script>
 </head>
   <body>
     <div id="aDiv"></div>
	 <div id="bDiv"></div>
 </body>
 </html>